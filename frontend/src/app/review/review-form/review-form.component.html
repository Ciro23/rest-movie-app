<div class="d-flex justify-content-between">
  <app-back-button></app-back-button>
  <app-action-buttons
    *ngIf="!editMode"
    class="align-self-end"
    [onEdit]="edit"
    [onDownloadPdf]="downloadPdf"
    [onDelete]="delete"></app-action-buttons>
</div>

<h2 *ngIf="reviewId && !editMode" class="text-center">View review</h2>
<h2 *ngIf="reviewId && editMode" class="text-center">Edit review</h2>
<h2 *ngIf="!reviewId && editMode" class="text-center">Add a new review</h2>

<form
  class="d-flex flex-column m-auto px-5 gap-3 mt-4"
  (ngSubmit)="save(form)"
  #form="ngForm">

  <div class="d-flex gap-3 flex-wrap">
    <label class="d-flex flex-column flex-grow-1">
      Movie*
      <app-autocomplete-field
        *ngIf="editMode"
        [isInvalid]="form.submitted && !reviewForm.movie"
        [placeholder]="'Search by title'"
        [getDisplayValue]="getMovieTitle"
        [search]="searchMoviesByTitle"
        [selectedItems]="reviewForm.movie ? [reviewForm.movie] : []"
        (onSelectedItems)="onSelectMovie($event)"></app-autocomplete-field>

      <input
        *ngIf="!editMode"
        [(ngModel)]="reviewForm.movie!.title"
        name="movie_title"
        class="px-2 py-1 form-control"
        type="text"
        disabled>
    </label>

    <label class="d-flex flex-column flex-grow-1">
      User*
      <app-autocomplete-field
        *ngIf="editMode"
        [isInvalid]="form.submitted && !reviewForm.user"
        [placeholder]="'Search by username'"
        [getDisplayValue]="getUserEmail"
        [search]="searchUsersByEmail"
        [selectedItems]="reviewForm.user ? [reviewForm.user] : []"
        (onSelectedItems)="onSelectUser($event)"></app-autocomplete-field>

      <input
        *ngIf="!editMode"
        [(ngModel)]="reviewForm.user!.username"
        name="user_username"
        class="px-2 py-1 form-control"
        type="text"
        disabled>
    </label>
  </div>

  <div class="d-flex gap-3 flex-wrap">
    <label class="d-flex flex-column flex-grow-1">
      Creation date*
      <input
        [(ngModel)]="creationDate"
        class="form-control"
        name="creation date"
        type="date"
        disabled
        >
    </label>

    <label class="d-flex flex-column flex-grow-1">
      Vote*
      <input
        [(ngModel)]="reviewForm.vote"
        [disabled]="!editMode"
        [ngClass]="{'is-invalid': form.submitted && form.controls['vote'].invalid}"
        class="form-control"
        name="vote"
        type="number"
        min="0"
        max="10"
        required>
    </label>
  </div>

  <label class="d-flex flex-column">
    Content
    <textarea
      [(ngModel)]="reviewForm.content"
      [disabled]="!editMode"
      class="form-control"
      name="content"
      type="text"
      rows="7"></textarea>
  </label>

  <app-save-and-cancel-buttons *ngIf="editMode"></app-save-and-cancel-buttons>
</form>
<ul *ngIf="errorMessages.length !== 0" class="w-75 m-auto alert alert-danger mt-4">
  <li *ngFor="let errorMessage of errorMessages" class="ms-4">
    {{ errorMessage }}
  </li>
</ul>
